TPC-C for WarehousePG

$ sudo su - gpadmin

1. pg_hba.conf 접속 가능하도록 수정 
$ vi pg_hba.conf 
# "local" is for Unix domain socket connections only
local   all             all                                     md5
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
host    all             all             0.0.0.0/0            md5

2. (옵션) postgresql.conf 필요한 부분 수정.

3. java 와 maven 설치.
$ sudo dnf install git java-21-openjdk-devel maven 

4. Database 와 사용자 생성.
$ psql -d postgres
CREATE USER benchmarksql WITH ENCRYPTED PASSWORD 'changeme';
CREATE DATABASE benchmarksql OWNER benchmarksql;
\q

5.(옵션) 환경 설정
export PGPORT=5432
export PGDATABASE=benchmarksql
export PGUSER=benchmarksql
export PGPASSWORD=changeme
export PGHOST=whpg-m

6. 테스트 툴 다운로드 및 빌드
$ git clone https://github.com/pgsql-io/benchmarksql.git

$ git cline https://github.com/petergeoghegan/benchmarksql

$ cd benchmarksql
$ mvn

7. 테스트 수행 준비. 
   properties 파일을 환경에 맞게 수정.

$ cd target/run
$ cp sample.postgresql.properties whpg.properties

$ vi whpg.properties
db=postgres
driver=org.postgresql.Driver
application=Generic
conn=jdbc:postgresql://whpg-m:5432/benchmarksql
user=benchmarksql
password=changeme

# Scaling and timing configuration
warehouses=50                # data set의 크기.
useWarehouseFrom=-1
useWarehouseTo=-1
loadWorkers=8                # 데이터 적재시 동시 수행 프로세스 수.
monkeys=2
sutThreads=32.               #  동시 사용자 수
maxDeliveryBGThreads=12
maxDeliveryBGPerWarehouse=2
rampupMins=5
rampupSUTMins=1
rampupTerminalMins=1
reportIntervalSecs=30
restartSUTThreadProbability=0.0

keyingTimeMultiplier=0.1      # 키보드 입력 간 시간 조정.
thinkTimeMultiplier=0.1       # 사용자가 생각하는 시간 조정.
terminalMultiplier=2

traceTerminalIO=false
runMins=10
runTxnsPerTerminal=0

====

conn=jdbc:postgresql://whpg-m:5432/benchmarksql
user=benchmarksql
password=changeme

# Scaling and timing configuration
#warehouses=50
warehouses=10
useWarehouseFrom=-1
useWarehouseTo=-1
#loadWorkers=8
loadWorkers=2
monkeys=2
#sutThreads=16
sutThreads=8

8. Greenplum(WarehousePG) 에 맞게 table 생성 SQL 수정.
   vi target/run/sql.common/tableCreates.sql

   DISTRIBUTED BY 구문 추가.
```
#TPC-C Table for WarehousePG
create table bmsql_config (
  cfg_name    varchar(30) primary key,
  cfg_value   varchar(50)
)
DISTRIBUTED BY (cfg_name);

create table bmsql_warehouse (
  w_id        integer   not null,
  w_ytd       decimal(12,2),
  w_tax       decimal(4,4),
  w_name      varchar(10),
  w_street_1  varchar(20),
  w_street_2  varchar(20),
  w_city      varchar(20),
  w_state     char(2),
  w_zip       char(9)
)
DISTRIBUTED BY (w_id);

create table bmsql_district (
  d_w_id       integer       not null,
  d_id         integer       not null,
  d_ytd        decimal(12,2),
  d_tax        decimal(4,4),
  d_next_o_id  integer,
  d_name       varchar(10),
  d_street_1   varchar(20),
  d_street_2   varchar(20),
  d_city       varchar(20),
  d_state      char(2),
  d_zip        char(9)
)
DISTRIBUTED BY (d_w_id,d_id);

create table bmsql_customer (
  c_w_id         integer        not null,
  c_d_id         integer        not null,
  c_id           integer        not null,
  c_discount     decimal(4,4),
  c_credit       char(2),
  c_last         varchar(16),
  c_first        varchar(16),
  c_credit_lim   decimal(12,2),
  c_balance      decimal(12,2),
  c_ytd_payment  decimal(12,2),
  c_payment_cnt  integer,
  c_delivery_cnt integer,
  c_street_1     varchar(20),
  c_street_2     varchar(20),
  c_city         varchar(20),
  c_state        char(2),
  c_zip          char(9),
  c_phone        char(16),
  c_since        timestamp,
  c_middle       char(2),
  c_data         varchar(500)
)
DISTRIBUTED BY (c_w_id,c_d_id,c_id);

create table bmsql_history (
  h_c_id   integer,
  h_c_d_id integer,
  h_c_w_id integer,
  h_d_id   integer,
  h_w_id   integer,
  h_date   timestamp,
  h_amount decimal(6,2),
  h_data   varchar(24)
)
DISTRIBUTED BY (h_c_id, h_c_d_id, h_c_w_id, h_d_id, h_w_id);

create table bmsql_new_order (
  no_w_id  integer   not null,
  no_d_id  integer   not null,
  no_o_id  integer   not null
)
DISTRIBUTED BY (no_w_id,no_d_id,no_o_id);

create table bmsql_oorder (
  o_w_id       integer      not null,
  o_d_id       integer      not null,
  o_id         integer      not null,
  o_c_id       integer,
  o_carrier_id integer,
  o_ol_cnt     integer,
  o_all_local  integer,
  o_entry_d    timestamp
)
DISTRIBUTED BY (o_w_id,o_d_id,o_id);

create table bmsql_order_line (
  ol_w_id         integer   not null,
  ol_d_id         integer   not null,
  ol_o_id         integer   not null,
  ol_number       integer   not null,
  ol_i_id         integer   not null,
  ol_delivery_d   timestamp,
  ol_amount       decimal(6,2),
  ol_supply_w_id  integer,
  ol_quantity     integer,
  ol_dist_info    char(24)
)
DISTRIBUTED BY (ol_w_id,ol_d_id,ol_o_id,ol_number);

create table bmsql_item (
  i_id     integer      not null,
  i_name   varchar(24),
  i_price  decimal(5,2),
  i_data   varchar(50),
  i_im_id  integer
)
DISTRIBUTED BY (i_id);

create table bmsql_stock (
  s_w_id       integer       not null,
  s_i_id       integer       not null,
  s_quantity   integer,
  s_ytd        integer,
  s_order_cnt  integer,
  s_remote_cnt integer,
  s_data       varchar(50),
  s_dist_01    char(24),
  s_dist_02    char(24),
  s_dist_03    char(24),
  s_dist_04    char(24),
  s_dist_05    char(24),
  s_dist_06    char(24),
  s_dist_07    char(24),
  s_dist_08    char(24),
  s_dist_09    char(24),
  s_dist_10    char(24)
)
DISTRIBUTED BY (s_w_id,s_i_id);
```

9. 테스트 수행을 위한 schema 생성 및 데이터 적제
$ ./runDatabaseBuild.sh whpg.properties

10. 테스트 수행
$ ./runBenchmark.sh whpg.properties

11. 테스트 수행 schema 및 데이터 삭제
$ ./runDatabaseDestroy.sh whpg.properties

12. 결과 리포트
generateReport.py

13. 초기 데이터 적재시 아래와 같은 에러가 발생하면
    Detail: System memory limit reached, failed to allocate 8388616 bytes from system
     Call getNextException to see other errors in the batch.

   => Batch 사이즈를 줄여야 함.  323 라인 변경, 472 이후 라인 추가.
     
    vi src/main/java/com/github/pgsqlio/benchmarksql/loader/LoadDataWorker.java 

    323 line : if (s_i_id != 1 && (s_i_id - 1) % 10000 == 0) { 
              -> if (s_i_id != 1 && (s_i_id - 1) % 30 == 0) {

    472         /* 50 batched */
    473         if (c_id != 1 && (c_id - 1) % 30 == 0) {
    474           stmtCustomer.executeBatch();
    475           stmtCustomer.clearBatch();
    476           stmtHistory.executeBatch();
    477           stmtHistory.clearBatch();
    478         }

   ==> mvn clean; mvn

   ==> gp_vmem_protect_limit 설정을 상향 조정하는 것을 고려.. 
   gpconfig -c gp_vmem_protect_limit -v 10240
