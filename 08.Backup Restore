1.DB coordinator 노드에서 백업

1-1. 백업 폴더 생성 및 권한 부여 
sudo mkdir /data/backup
ssh whpg-sm sudo mkdir /data/backup
ssh whpg-s1 sudo mkdir /data/backup
ssh whpg-s2 sudo mkdir /data/backup
sudo chown -R gpadmin:gpadmin /data/backup
ssh whpg-sm sudo chown -R gpadmin:gpadmin /data/backup
ssh whpg-s1 sudo chown -R gpadmin:gpadmin /data/backup
ssh whpg-s2 sudo chown -R gpadmin:gpadmin /data/backup

1-2. Source WHPG segment 

whpg=# select * from gp_segment_configuration;
 dbid | content | role | preferred_role | mode | status | port | hostname | address |          datadir           
------+---------+------+----------------+------+--------+------+----------+---------+----------------------------
    1 |      -1 | p    | p              | n    | u      | 5432 | whpg-m   | whpg-m  | /data7/coordinator/gpseg-1
    2 |       0 | p    | p              | n    | u      | 6000 | whpg-s1  | whpg-s1 | /data7/primary/gpseg0
    4 |       2 | p    | p              | n    | u      | 6000 | whpg-s2  | whpg-s2 | /data7/primary/gpseg2
    3 |       1 | p    | p              | n    | u      | 6001 | whpg-s1  | whpg-s1 | /data7/primary/gpseg1
    5 |       3 | p    | p              | n    | u      | 6001 | whpg-s2  | whpg-s2 | /data7/primary/gpseg3

2. 백업 수행.
gpbackup --dbname whpg --backup-dir /data/backup --compression-level 5 --leaf-partition-data

3. DB 삭제 후 재 생성.

/data7 -> /data1 과 /data2

4. 신규 DB에서 복구 

4-1. 신규 DB 확인.
$ psql -d whpg
whpg=# \l
                                List of databases
   Name    |  Owner  | Encoding |   Collate   |    Ctype    |  Access privileges  
-----------+---------+----------+-------------+-------------+---------------------
 postgres  | gpadmin | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | gpadmin | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/gpadmin         +
           |         |          |             |             | gpadmin=CTc/gpadmin
 template1 | gpadmin | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/gpadmin         +
           |         |          |             |             | gpadmin=CTc/gpadmin
 whpg      | gpadmin | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

4-2. Restore
[gpadmin@whpg-m ~]$ gprestore --backup-dir /data/backup 

=====================================================
다양한 백업 복구 예시
=====================================================
1.백업 디렉토리 생성 혹은 NAS/S3 연결.
All
=> mkdir /data/backup

2.메타데이터만 백업 (데이터 제외)		
gpbackup --dbname tpchc --backup-dir /data/backup_metadata_$(date +%m%d%H%M) --metadata-only --jobs 2

3. 증분 백업
gpbackup --dbname postgres --backup-dir /data1/backup/ --leaf-partition-data --incremental --from-timestamp "20251111100952" 

4. DB 스키마 단위 백업		
gpbackup --dbname tpchc --backup-dir /backup --leaf-partition-data --with-stats --jobs 2 --include-schema tpch  > /data/backup/schema_$(date +%m%d%H%M).log 2>&1 &

5. DB 테이블 단위 백업
gpbackup --dbname tpchc --backup-dir /backup --leaf-partition-data --with-stats --jobs 2 --include-table tpch.orders  > /data/backup/table_$(date +%m%d%H%M).log 2>&1 &

6. 특정 타임스탬프의 백업본 전체 복원
gprestore --timestamp 20241125120000

7. # 'original_db'의 백업을 'new_db'로 복원
gprestore --timestamp 20241125120000 --redirect-db new_db

8.public 스키마의 sales 테이블만 복원
gprestore --timestamp 20241125120000 --include-table public.sales

9. 여러 테이블 복원
gprestore --timestamp 20241125120000 --include-table public.sales --include-table hr.employee

10. finance 스키마에 속한 모든 객체 복원
gprestore --timestamp 20241125120000 --include-schema finance

11.tables_to_restore.txt 파일에 테이블 목록이 한 줄에 하나씩 있어야 함
gprestore --timestamp 20241125120000 --include-table-file ./tables_to_restore.txt

12. DDL 만 복원
gprestore --timestamp 20241125120000 --metadata-only

13. 데이터만 복원
gprestore --timestamp 20241125120000 --data-only

14. 에러 무시하고 진행
gprestore --timestamp 20241125120000 --on-error-continue

15. 외부 스토리지(S3 등)에서 복원
gprestore --timestamp 20241125120000 --plugin-config /home/gpadmin/s3_config.yaml

16. 의존성 문제 해결하면서 복원
gprestore --timestamp 20241125120000 --with-globals

17. 4개의 병렬 작업으로 메타데이터 복원 수행
gprestore --timestamp 20241125120000 --jobs 4




